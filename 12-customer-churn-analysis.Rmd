# 顧客流失分析 {#customer-churn-analysis}

(https://towardsdatascience.com/predict-customer-churn-with-r-9e62357d47b4)

載入套件
```{r}
library(tidyverse)
library(lubridate)
library(readxl)
```

讀取資料集檔案[線上零售資料集](https://archive.ics.uci.edu/ml/datasets/Online+Retail)
```{r}
Online_Retail <- read_excel("Online Retail.xlsx")
```

檢視資料集，這是一個發票的檔案，包含發票編號(InvoiceNo)、貨品編號(StockCode)、描述(Description)、數量(Quantity)、發票日期(InvoiceDate)、單價(UnitPrice)、顧客識別號(CustomerID)、國別(Country)等變數欄位。
```{r}
summary(Online_Retail)
```

其中，顧客識別號(CustomerID)有許多NA(Not-Available)，先將這些資料去除，保留非NA的資料
```{r}
Online_Retail <- Online_Retail %>%
  filter(!is.na(CustomerID))
```

發票日期(InvoiceDate)在2010-12-01到2011-12-09間，稍微超過一年，為了方便計算起見，取2010-12-09到2011-12-09之間的資料
```{r}
Online_Retail <- Online_Retail %>%
  filter(InvoiceDate>=as.Date("2010-12-09"))
```

計算每個顧客的最近購買日期(與2011-12-10的差)和購買頻率(一年的購買次數)。

- 首先，依據發票編號是否包含"C"，利用`!grepl()`函數將發票紀錄區分為購買(purchase)或退貨(return)兩類，只計算購買紀錄(沒有包含C)，去除退貨紀錄(包含C)。
- 計算購買日期與2011-12-10差幾天，並利用`as.numeric()`函數將其資料型態轉成numeric
- 依據CustomerID，將發票紀錄分組，統計每個使用者的最近購買日期(與2011-12-10差距最小者)和購買頻率(不同的發票編號，一年內購買幾次)
```{r}
customers <- Online_Retail %>%
  filter(!grepl("C", InvoiceNo)) %>% #只計算購買紀錄，去除退貨紀錄
  mutate(date.diff = as.numeric(as.Date("2011-12-10") - as.Date(InvoiceDate))) %>% #計算購買日期與2011-12-10差幾天
  group_by(CustomerID) %>% #依據CustomerID，將發票紀錄分組
  summarise(recency = min(date.diff),        #最近購買日期
            frequency=n_distinct(InvoiceNo)) #購買頻率(一年內購買幾次)
```

計算每個顧客的購買金額(減去退貨的情形)

- 依據CustomerID，將發票紀錄分組，統計每個使用者的消費紀錄總和(單價*數量)
- 去除消費紀錄總和為負的情形(退貨金額大於購買金額)
```{r}
customers1 <- Online_Retail %>%
  group_by(CustomerID) %>%
  summarise(monetary=sum(UnitPrice*Quantity)) %>%
  filter(monetary>=0)
```

整合最近購買日期、購買頻率和購買金額的資料
```{r}
customers <- customers %>%
  inner_join(customers1)
```

檢視各特徵的統計敘述
```{r}
summary(customers)
```

```{r}
customers %>%
  filter(frequency>=20)
```

計算每一筆紀錄的消費金額(數量*單價)
```{r}
Online_Retail <- Online_Retail %>%
  mutate(Total=Quantity*UnitPrice)
```

計算每一個顧客每一天每一張發票上的消費金額總數
```{r}
txns <- Online_Retail %>% 
  group_by(CustomerID, InvoiceNo, InvoiceDate) %>% 
  summarise(Spend = sum(Total)) %>%
  ungroup() %>% 
  filter(Spend>0) #去除退貨資料，保留購物資料
```

每一個顧客前後筆購物資料時間差距
```{r}
time_between <- txns %>% 
  arrange(CustomerID, InvoiceDate) %>% 
  group_by(CustomerID) %>% 
  mutate(dt = as.numeric(InvoiceDate - lag(InvoiceDate), unit=  'days')) %>% 
  ungroup() %>% 
  filter(!is.na(dt))
```

購買紀錄大於20筆的顧客資料
```{r}
Ntrans <- txns %>% 
  group_by(CustomerID) %>% 
  summarise(N = n()) %>%
  filter(N>20)
```

每一位顧客的
```{r}
ecdf_df <- time_between %>%
  group_by(CustomerID) %>%
  arrange(CustomerID, dt) %>%
  mutate(e_cdf = 1:length(dt)/length(dt)) %>%
  ungroup
```

```{r}
approx(ecdf_df$e_cdf[ecdf_df$CustomerID==ecdf_df$CustomerID[1]], ecdf_df$dt[ecdf_df$CustomerID==ecdf_df$CustomerID[1]], xout=0.9)
```

```{r}
x <- percentiles %>%
  filter(CustomerID==.$CustomerID[1]) %>%
  arrange(dt)
```

