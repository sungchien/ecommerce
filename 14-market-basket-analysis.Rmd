#購物籃分析 {#market-basket-analysis}

https://towardsdatascience.com/a-gentle-introduction-on-market-basket-analysis-association-rules-fa4b986a40ce

##購物籃分析簡介

購物籃分析又稱關聯分析，其目的是從大量的交易資料中，探勘出在資料間具有相關性的隱藏規則。找出這些隱藏規則後，嘗試發現消費者通常買什麼，哪些商品經常會被一起購買。購物籃分析最經典的就是啤酒與尿布的例子。

##
購物籃分析的演算概念主要為兩個機率統計量的計算，分別為支持度(Support)和信賴度(Confidence)。以下用一個例子來說明，此處所有的發票共有2000筆(以下以$C$代表)，包含A產品的發票有1250(750+500)筆(以$C_{A}$代表)，包含B產品的發票則有1000(500+500)筆(以$C_{A}$代表)，同時包含A產品與B產品的發票有500筆。

![](image/mbdata.png)

我們將計算購買A產品時也一起購買B產品(${A}\Rightarrow{B}$)的支持度與信賴度

- 支持度(Support) ：
在所有的發票中，同時購買A、B產品的次數比例 $Pr(A, B)=\frac{C_{A, B}}{C}=\frac{500}{2000}=0.25$

- 信賴度(Confidence) ：
在購買A產品的發票中，同時也購買B產品的次數比例 $Pr(B|A)=\frac{Pr(A,B)}{Pr(A)}=\frac{\frac{C_{A, B}}{C}}{\frac{C_{A}}{C}}=\frac{\frac{500}{2000}}{\frac{1250}{2000}}=0.4$

在進行購物籃分析時，需要先設定最小支持度與最小信賴度。如果所設定的最小支持度與最小信賴度太低，則會產生太多規則，造成決策上的干擾。反之，最小支持度與最小信賴度的設定太高則可能會面臨規則太少，難以判斷的窘境。

一個強關聯規則，通常支持度和信賴度的值都很高。但支持度和信賴度值高的規則，卻不一定代表這條規則所指的事件彼此間就一定存在著高相關性。同時還需檢查增益率(Lift)值是否大於1。

  - 當增益度的值＞1， 則A與B間有正向關係
  - 當增益度的值＝1， 則A與B間沒有關係
  - 當增益度的值＜1， 則A與B間為負向關係

增益率的計算方式：$\frac{Pr(B|A)}{Pr(B)}=\frac{Pr(A,B)}{Pr(A)Pr(B)}$

##購物籃分析的應用
載入套件
```{r}
library(tidyverse)
library(lubridate) #處理時間資料
library(readxl) #讀取excel檔案
library(arules)
library(arulesViz)
```

讀取資料集檔案[線上零售資料集](https://archive.ics.uci.edu/ml/datasets/Online+Retail)
```{r}
Online_Retail <- read_excel("Online Retail.xlsx")
```

檔案中包含發票編號(InvoiceNo)、貨品編號(StockCode)、描述(Description)、數量(Quantity)、發票日期(InvoiceDate)、單價(UnitPrice)、顧

首先，去除顧客識別號(CustomerID)資料中的NA(Not-Available)，保留非NA的資料，然後再選取發票日期(InvoiceDate)在2010-12-09到2011-12-09之間的資料。
```{r}
Online_Retail <- Online_Retail %>%
  filter(!is.na(CustomerID)) %>% #去除去除顧客識別號中的NA
  filter(InvoiceDate>=as.POSIXct("2010-12-09")) #選取2010-12-09到2011-12-09之間的資料
```

```{r}
Online_Retail <- Online_Retail %>%
  mutate(Date=as.Date(InvoiceDate))
```

```{r}
Online_Retail <- Online_Retail %>%
  filter(!grepl("C", InvoiceNo))
```

```{r}
retail <- Online_Retail %>%
  select(InvoiceNo, Description) %>%
  mutate(InvoiceNo=as.factor(InvoiceNo))
```

```{r}
write.table(retail, file = tmp <- file(), row.names = FALSE)
```

```{r}
trans <- read.transactions(tmp,
                           format = "single",
                           header = TRUE,
                           cols = c("InvoiceNo", "Description"))
close(tmp)
```

```{r}
summary(trans)
```

```{r}
itemFrequencyPlot(trans, topN=20, type='absolute')
```

